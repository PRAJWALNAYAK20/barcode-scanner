<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Smart Barcode Scanner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    * {
      box-sizing: border-box;
      font-family: "Segoe UI", Roboto, Arial, sans-serif;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background: radial-gradient(circle at top, #0f172a, #020617);
      color: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    .card {
      width: 100%;
      max-width: 420px;
      background: rgba(15, 23, 42, 0.95);
      border-radius: 18px;
      padding: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.5);
      border: 1px solid rgba(148,163,184,0.15);
    }

    h1 {
      margin: 0 0 12px;
      font-size: 22px;
      text-align: center;
      color: #38bdf8;
      letter-spacing: 0.5px;
    }

    p.subtitle {
      margin: 0 0 16px;
      font-size: 13px;
      text-align: center;
      color: #94a3b8;
    }

    input {
      width: 100%;
      padding: 12px 14px;
      border-radius: 10px;
      border: none;
      outline: none;
      background: #020617;
      color: #e5e7eb;
      border: 1px solid rgba(148,163,184,0.25);
      margin-bottom: 14px;
      font-size: 14px;
    }

    input::placeholder {
      color: #64748b;
    }

    video {
      width: 100%;
      border-radius: 14px;
      margin-bottom: 14px;
      border: 1px solid rgba(148,163,184,0.2);
    }

    button {
      width: 100%;
      padding: 14px;
      border-radius: 12px;
      border: none;
      background: linear-gradient(135deg, #38bdf8, #0ea5e9);
      color: #020617;
      font-weight: 600;
      font-size: 15px;
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.1s ease;
      box-shadow: 0 8px 20px rgba(56,189,248,0.35);
    }

    button:active {
      transform: scale(0.98);
      box-shadow: 0 4px 10px rgba(56,189,248,0.25);
    }

    #status {
      margin-top: 14px;
      text-align: center;
      font-size: 14px;
      color: #a5f3fc;
      min-height: 18px;
    }

    footer {
      margin-top: 14px;
      text-align: center;
      font-size: 11px;
      color: #64748b;
    }
  </style>
</head>

<body>

  <div class="card">
    <h1>ðŸ“· Smart Scanner</h1>
    <p class="subtitle">Scan QR / Barcodes securely</p>

    <input id="userId" placeholder="Enter User ID (required)" />

    <video id="video" autoplay playsinline></video>

    <button onclick="startScan()">Start Scan</button>

    <div id="status"></div>

    <footer>
      Data stored securely in Google Sheets
    </footer>
  </div>

<script>
const video = document.getElementById("video");
const status = document.getElementById("status");
const userIdInput = document.getElementById("userId");

const SCRIPT_URL =
"https://script.google.com/macros/s/AKfycbwiVwDFnspMbp29p7XKR0i-I-ZpMQTjvX5Uk2NaCpQiyJSlzbwDDoH4Vb3XG3WFwc7C/exec";

let scanning = false;

async function startScan() {
  if (!userIdInput.value.trim()) {
    alert("Please enter User ID");
    return;
  }

  if (scanning) return;
  scanning = true;

  status.innerText = "ðŸ“¸ Opening camera...";

  const stream = await navigator.mediaDevices.getUserMedia({
    video: { facingMode: "environment" }
  });

  video.srcObject = stream;

  const detector = new BarcodeDetector({
    formats: ["qr_code", "ean_13", "code_128"]
  });

  status.innerText = "ðŸ” Scanning...";

  const interval = setInterval(async () => {
    const codes = await detector.detect(video);

    if (codes.length > 0) {
      clearInterval(interval);
      stream.getTracks().forEach(t => t.stop());

      const value = codes[0].rawValue;
      status.innerText = "âœ… Scanned successfully";

      saveToSheet(value);
      scanning = false;
    }
  }, 900);
}

function saveToSheet(value) {
  navigator.geolocation.getCurrentPosition(pos => {
    fetch(SCRIPT_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        barcode: value,
        latitude: pos.coords.latitude,
        longitude: pos.coords.longitude,
        userId: userIdInput.value,
        device: navigator.userAgent
      })
    })
    .then(r => r.text())
    .then(t => console.log("Server:", t))
    .catch(e => console.error(e));
  });
}
</script>

</body>
</html>
