<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Smart Barcode Scanner</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body>

<input id="userId" placeholder="Enter User ID" />
<video id="video" autoplay playsinline></video>
<button onclick="startScan()">Start Scan</button>
<div id="status"></div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwiVwDFnspMbp29p7XKR0i-I-ZpMQTjvX5Uk2NaCpQiyJSlzbwDDoH4Vb3XG3WFwc7C/exec";
const video = document.getElementById("video");
const userIdInput = document.getElementById("userId");
const status = document.getElementById("status");

let scanning = false;

async function startScan() {
  if (!userIdInput.value) {
    alert("Enter User ID");
    return;
  }

  const stream = await navigator.mediaDevices.getUserMedia({
    video: { facingMode: "environment" }
  });

  video.srcObject = stream;
  const detector = new BarcodeDetector({ formats: ["qr_code"] });

  const interval = setInterval(async () => {
    const codes = await detector.detect(video);
    if (codes.length) {
      clearInterval(interval);
      stream.getTracks().forEach(t => t.stop());
      saveToSheet(codes[0].rawValue);
    }
  }, 800);
}

function saveToSheet(value) {
  navigator.geolocation.getCurrentPosition(pos => {
    const form = new FormData();
    form.append("barcode", value);
    form.append("latitude", pos.coords.latitude);
    form.append("longitude", pos.coords.longitude);
    form.append("userId", userIdInput.value);
    form.append("device", navigator.userAgent);

    fetch(SCRIPT_URL, {
      method: "POST",
      mode: "no-cors",
      body: form
    });
  });
}
</script>

</body>
</html>
