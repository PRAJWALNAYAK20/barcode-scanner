<!DOCTYPE html>
<html>
<head>
  <title>Barcode Scanner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body style="text-align:center;font-family:Arial">

<h2>Scanner</h2>
<video id="video" autoplay playsinline style="width:90%"></video>
<br><br>
<button onclick="startScan()">Start Scan</button>
<p id="status"></p>

<script>
const video = document.getElementById("video");
const status = document.getElementById("status");

const SCRIPT_URL =
"https://script.google.com/macros/s/AKfycbwiVwDFnspMbp29p7XKR0i-I-ZpMQTjvX5Uk2NaCpQiyJSlzbwDDoH4Vb3XG3WFwc7C/exec";

let scanning = false;

async function startScan() {
  if (scanning) return;
  scanning = true;

  status.innerText = "Opening camera...";

  const stream = await navigator.mediaDevices.getUserMedia({
    video: { facingMode: "environment" }
  });

  video.srcObject = stream;

  if (!("BarcodeDetector" in window)) {
    status.innerText = "BarcodeDetector not supported. Use Chrome.";
    return;
  }

  const detector = new BarcodeDetector({
    formats: ["qr_code", "ean_13", "code_128"]
  });

  status.innerText = "Scanning...";

  const interval = setInterval(async () => {
    const codes = await detector.detect(video);

    if (codes.length > 0) {
      clearInterval(interval);
      stream.getTracks().forEach(t => t.stop());

      const value = codes[0].rawValue;
      status.innerText = "Scanned: " + value;

      saveToSheet(value);
      scanning = false;
    }
  }, 1000);
}

function saveToSheet(value) {
  fetch(SCRIPT_URL, {
    method: "POST",
    mode: "no-cors",
    body: JSON.stringify({
      barcode: value,
      device: navigator.userAgent
    })
  });
}
</script>

</body>
</html>
